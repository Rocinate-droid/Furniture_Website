{% extends 'main.html' %}
{% load humanize %}
{% block content %}
{% load static %}
{% load dict_extras %}
<div class="container py-5" id="product-part">
  
  <div class="row">
    <!-- Product Images (Sticky Left) -->
    <div class="col-md-6">
      <div class="breadcrumbs-mobile-only">
  <ul class="breadcrumb">
  <li><a href="{% url 'home' %}">Home</a></li>
  <li><a href="{% url 'rooms' room_type=product.room_or_Product_Type.slug  %}">{{product.room_or_Product_Type.name}}</a></li>
  <li><a href="{{request.path}}">{{product.name}}</a></li>
</ul>
</div>
      <div class="sticky-top" style="top: 100px;"> <!-- adjust top offset as needed -->
        <img id="mainImage" src="{{product.img.url}}" class="img-fluid mb-3" alt="Main Image">
        <div class="d-flex">
          <img src="{{product.img.url}}" class="thumbnail-img active" width="60" onclick="changeImage(this)">
          <img src="{{product.img2.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
          <img src="{{product.img3.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
          <img src="{{product.img3.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
        </div>
      </div>
    </div>

    <!-- Product Details (Scrollable Right) -->
    <div class="col-md-6">
        <div class="breadcrumbs-desktop-only">
  <ul class="breadcrumb">
  <li><a href="{% url 'home' %}">Home</a></li>
  <li><a href="{% url 'rooms' room_type=product.room_or_Product_Type.slug  %}">{{product.room_or_Product_Type.name}}</a></li>
  <li><a href="{{request.path}}">{{product.name}}</a></li>
</ul>
</div>
      <h4>{{product.name}}</h4>
      <p class="mb-1">
        <strong>₹{{product.discounted_price | intcomma}}</strong>
        <span class="price-original">₹{{product.original_price | intcomma}}</span>
        <small>(Including GST)</small>
      </p>
      <p class="text-success">
        You Save ₹{{product.savings}} ({{product.savings_percentage}}% OFF)
      </p>
      <p>{{product.warranty}} Year Warranty</p>

      <!-- Price Table -->
      <table class="table table-sm">
        <tbody>
          <tr>
            <td><strong>Total Savings</strong></td>
            <td class="text-danger">₹{{product.savings}}</td>
          </tr>
          <tr>
            <td><strong>Assembly</strong></td>
            <td>{{product.assembly}}</td>
          </tr>
          <tr>
            <td><strong>Customization</strong></td>
            <td>{{product.customization}}</td>
          </tr>
          <tr>
            <td><strong>Tax</strong></td>
            <td>18%</td>
          </tr>
        </tbody>
      </table>

      <!-- Quantity & Price -->
      <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm" onclick="adjustQty(-1, {{product.id}})">-</button>
        <input id="qtyInput" type="text" value="1" class="form-control form-control-sm mx-2 text-center"
          style="width: 50px;">
        <button class="btn btn-outline-secondary btn-sm" onclick="adjustQty(1, {{product.id}})">+</button>
        <strong class="ms-3">₹<span id="totalPrice">{{product.discounted_price}}</span></strong>
      </div>

      <!-- Actions -->
      
        <div class="d-flex flex-column flex-sm-row gap-2 mb-4">
           {% if user.is_authenticated %}
        <button class="btn btn-outline-secondary w-10 changebutton" onclick="addToWishlist({{product.id}})" style="background: transparent;border: none !important;background-color: #E5D9D9" ><div class="discount-badge"><svg {% if product.id in wish_items %} fill="red" {% else %} fill="none" {% endif %} class="icon" id="cart-like{{product.id}}" height="24" width="24" stroke="red" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> 
        </div></button>
        {% else %}
        <button class="btn btn-outline-secondary w-10 changebutton" onclick="location.href='/login'" style="border: none !important; background-color: #E5D9D9;" ><div class="discount-badge"><svg {% if product.id in wish_items %} fill="red" {% else %} fill="none" {% endif %} class="icon" id="cart-like{{product.id}}" height="24" width="24" stroke="red" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> 
        </div></button>
        
        {% endif %}
         <button class="btn btn-outline-secondary w-50 changebutton" id="addtocart" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas" onclick="addToCart({{product.id}})">Add to Cart</button>
           
          <a class="btn btn-orange w-50 changebutton id="buynow" href="/buy/{{ product.id }}/1/">Buy Now</a>
         

            
        </div>

      <!-- ===== Offers Section ===== 

      <div class="mt-4">
        <h5>Save Extra with Below Offers</h5>
        <div class="d-flex flex-wrap gap-2">
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>InstantCart Deals</strong>
            <p class="mb-1 small">Get Up to <span class="text-danger">5% off</span> Order Now — Limited-Time!</p>
          </div>
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>Store Discount</strong>
            <p class="mb-1 small">Get up to <span class="text-danger">10% off</span> at stores.</p>
          </div>
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>No Cost EMI</strong>
            <p class="mb-1 small">Get it for ₹2154/m</p>
          </div>
        </div>
      </div>
    -->
      <!-- ===== Delivery Check ===== -->
      <div class="mt-4">
        <h5>Check Delivery Date</h5>
        <div class="input-group" style="max-width: 350px;">
          <input type="text" id="pincodeInput" class="form-control" placeholder="Enter Pincode">
          <button class="btn btn-outline-secondary" id="pincodeClick" onclick="checkDelivery()">APPLY</button>
        </div>
        <small class="text-muted" id="text-para">Enter your pincode to check delivery availability, assembly info &
          details</small><br>
        <small class="text-muted" id="text-para2"></small>
      </div>

      <!-- ===== Customer Reviews Section ===== -->
      <div class="mt-5">
        <h4>Customer Reviews</h4>
        <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
  <!-- Review text -->
  <div>
    {% if reviews.count == 0 %}
      <span>No reviews yet. Be the first to review!</span>
    {% else %}
    {% if overall_rating == 5 %}<span class="text-warning fs-4">
            ★★★★★
            {% elif overall_rating == 4 %}
            ★★★★
            {% elif overall_rating == 3 %}
            ★★★
            {% elif overall_rating == 2 %}
            ★★
            {% elif overall_rating == 1 %}
            ★
            {% endif %}
          </span>
      <span>Based on {{ reviews.count }} review{{ reviews.count|pluralize }}</span>
    {% endif %}
  </div>

  <!-- Review button -->
  <div class="mt-2 mt-sm-0">
    <button class="btn btn-outline-dark btn-sm review-btn"
            data-bs-toggle="modal" data-bs-target="#reviewModal">
      Write a review
    </button>
  </div>
</div>



        
        {% if reviews.count != 0 %}
        <!-- Ratings Breakdown -->
        <div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★★★★</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{ review_dict.five_star|percentage:reviews.count }}%">
              </div>
            </div>
            <small>{{ review_dict.five_star|percentage:reviews.count }}% ({{ review_dict.five_star }})</small>
          </div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★★★☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{ review_dict.four_star|percentage:reviews.count }}%">
              </div>
            </div>
            <small>{{ review_dict.four_star|percentage:reviews.count }}% ({{ review_dict.four_star }})</small>
          </div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★★☆☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{review_dict.three_star|percentage:reviews.count}}%">
              </div>
            </div>
            <small>{{ review_dict.three_star|percentage:reviews.count }}% ({{review_dict.three_star}})</small>
          </div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★☆☆☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{review_dict.two_star|percentage:reviews.count}}%">
              </div>
            </div>
            <small>{{review_dict.two_star|percentage:reviews.count}}% ({{review_dict.two_star }})</small>
          </div>
          <div class="d-flex align-items-center mb-3">
            <span class="text-warning">★☆☆☆☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{ review_dict.one_star|percentage:reviews.count }}%">
              </div>
            </div>
            <small>{{ review_dict.one_star|percentage:reviews.count }}% ({{review_dict.one_star}})</small>
          </div>
        </div>

        <!-- Sort Dropdown -->
        <div class="mb-3">
          <select class="form-select form-select-sm" id="sort_order" style="max-width:200px;" onchange="">
            <option selected value="most_recent">Most Recent</option>
            <option value="highest_rating">Highest Rating</option>
            <option value="lowest_rating">Lowest Rating</option>
          </select>
        </div>
        {% endif %}

        <!-- Reviews Loop -->
         <div id="review-cards">
         {% include "furni/review-cards.html" with reviews=reviews %}
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Track Order Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModal">Drop a review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="review-container">
          <form method="POST" enctype="multipart/form-data" id="review-form">
            {% csrf_token %}
            {% if not user.is_authenticated %}
            <label>Name</label>
            <input type="text" class="reviewmodalpop" name="name" id="name" value="{{ form.name.value|default:'' }}">
            {% endif %}
            <div class="product-info">
              <img src="{{product.img.url}}" alt="Product Image" style="width: 80px; height: 80px;">
              <strong>How was the item?</strong>
            </div>

            <div class="stars">
              {% if form.instance.rating == 5 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star selected" data-value="3">&#9733;</span>
              <span class="star selected" data-value="4">&#9733;</span>
              <span class="star selected" data-value="5">&#9733;</span>
              {% elif form.instance.rating == 4 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star selected" data-value="3">&#9733;</span>
              <span class="star selected" data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 3 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star selected" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 2 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 1 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 0 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% else %}
              <span class="star" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% endif %}
            </div>

            <!-- Hidden input to store the rating -->
            <input type="hidden" name="rating" id="rating" value="{{ form.rating.value|default:'' }}" required>

            <textarea class="reviewmodalpop" name="review" rows="4"
              placeholder="What should other customers know?">{{form.review.value|default:''}}</textarea>

            <label class="upload-area">
              <input type="file" name="img" id="img" accept="image/png, image/jpeg">
              <div>Share a photo</div>
            </label>
            <img id="preview" src="{% if form.instance.img %}{{ form.instance.img.url }}{% else %}#{% endif %}"
              alt="Image Preview"
              style="width: 80px; height: 80px; {% if not form.instance.img %}display: none;{% endif %}"><br>

            <input type="text" class="reviewmodalpop" name="title" placeholder="Review Title" required
              value="{{ form.title.value|default:'' }}">

            <button type="submit" class="submit-btn btn btn-outline-secondary w-100">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @media screen and (max-width: 576px) {
  .changebutton {
    width: 100%!important;
  }
}
  .border-orange {
    border: 1px solid #ff6600;
    border-radius: 6px;
  }


  .review-container {
    max-width: 500px;
    margin: 0 auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .product-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .product-info img {
    width: 80px;
    height: 80px;
    object-fit: cover;
  }

  .stars {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    font-size: 1.5rem;
    cursor: pointer;
    justify-content: center;
  }

  .star {
    color: lightgray;
    transition: color 0.2s;
  }

  .star.hover,
  .star.selected {
    color: gold;
  }

  .reviewmodalpop {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    font-size: 1rem;
  }

  .upload-area {
    border: 2px dashed #ccc;
    border-radius: 4px;
    text-align: center;
    padding: 20px;
    color: #777;
    margin-bottom: 15px;
    cursor: pointer;
  }

  .upload-area input {
    display: none;
  }

  .review-btn {
  min-width: 150px; /* keeps good size on large screens */
}

@media (max-width: 576px) {
  .review-btn {
    width: 100%;  /* full width under text on small screens */
    min-width: auto;
  }
}
.jdgm-rev__pic-link {
    margin: 8px 5px 3px 0;
    padding: 0;
    display: inline-block;
    height: 120px;
    width: auto;
    cursor: pointer;
    overflow: hidden;
}
.jdgm-rev__pics {
    font-size: 0;
    white-space: nowrap;
    height: auto;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
}
.jdgm-rev__pic-img {
    display: block;
    width: auto;
    max-height: 100%;
    margin: 0;
    padding: 0;
    position: relative;
    top: 50%;
    transform: translateY(-50%);
    -webkit-transform: translateY(-50%);
    border-radius: 4px;
}
</style>
<script>
  function addToCart(productId) {
    const qty = document.getElementById("qtyInput").getAttribute("value")
    const url = `/add/${productId}/${qty}/`
    fetch(url, {
      headers: { "X-Requested-With": "XMLHttpRequest",
      "X-Template-Type": "quick-cart"
      }
    })
      .then(response => response.text())
      .then(html => {
        document.getElementById("quick-cart-page").innerHTML = html;
      })
  }
  function reviewSort() {
    const base = window.location.pathname;
    const sort_order = document.getElementById("sort_order").value;
    const params = new URLSearchParams();
    params.append("sort_order",sort_order);
    const review_url = base + "?" + params.toString();
    fetch(review_url, {
      headers: { "X-Requested-With": "XMLHttpRequest",
      }
    })
      .then(response => response.text())
      .then(html => {
        document.getElementById("review-cards").innerHTML = html;
      })
  }
    document.getElementById("sort_order").addEventListener("change", reviewSort)
</script>

{% endblock content %}