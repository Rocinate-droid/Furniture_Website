{% extends 'main.html' %}
{% load humanize %}
{% block content %}
{% load static %}
{% load dict_extras %}
<div class="container py-5">
  <div class="row">
    <!-- Product Images (Sticky Left) -->
    <div class="col-md-6">
      <div class="sticky-top" style="top: 100px;"> <!-- adjust top offset as needed -->
        <img id="mainImage" src="{{product.img.url}}" class="img-fluid mb-3" alt="Main Image">
        <div class="d-flex">
          <img src="{{product.img.url}}" class="thumbnail-img active" width="60" onclick="changeImage(this)">
          <img src="{{product.img2.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
          <img src="{{product.img3.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
          <img src="{{product.img3.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
        </div>
      </div>
    </div>

    <!-- Product Details (Scrollable Right) -->
    <div class="col-md-6">
      <h4>{{product.name}}</h4>
      <p class="mb-1">
        <strong>₹{{product.discounted_price | intcomma}}</strong>
        <span class="price-original">₹{{product.original_price | intcomma}}</span>
        <small>(Including GST)</small>
      </p>
      <p class="text-success">
        You Save ₹{{product.savings}} ({{product.savings_percentage}}% OFF)
      </p>
      <p>{{product.warranty}} Year Warranty</p>

      <!-- Price Table -->
      <table class="table table-sm">
        <tbody>
          <tr>
            <td><strong>Total Savings</strong></td>
            <td class="text-danger">₹{{product.savings}}</td>
          </tr>
          <tr>
            <td><strong>Assembly</strong></td>
            <td>{{product.assembly}}</td>
          </tr>
          <tr>
            <td><strong>Customization</strong></td>
            <td>{{product.customization}}</td>
          </tr>
          <tr>
            <td><strong>Tax</strong></td>
            <td>18%</td>
          </tr>
        </tbody>
      </table>

      <!-- Quantity & Price -->
      <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm" onclick="adjustQty(-1, {{product.id}})">-</button>
        <input id="qtyInput" type="text" value="1" class="form-control form-control-sm mx-2 text-center"
          style="width: 50px;">
        <button class="btn btn-outline-secondary btn-sm" onclick="adjustQty(1, {{product.id}})">+</button>
        <strong class="ms-3">₹<span id="totalPrice">{{product.discounted_price}}</span></strong>
      </div>

      <!-- Actions -->
      <form>
        <div class="d-flex flex-column flex-sm-row gap-2 mb-4">
          <button class="btn btn-orange w-100" id="buynow" formaction="/buy/{{ product.id }}/1/">Buy Now</button>
          <button class="btn btn-outline-secondary w-100" id="addtocart" formaction="/add/{{ product.id }}/1/">Add to
            Cart</button>

        </div>
      </form>

      <!-- ===== Offers Section ===== 

      <div class="mt-4">
        <h5>Save Extra with Below Offers</h5>
        <div class="d-flex flex-wrap gap-2">
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>InstantCart Deals</strong>
            <p class="mb-1 small">Get Up to <span class="text-danger">5% off</span> Order Now — Limited-Time!</p>
          </div>
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>Store Discount</strong>
            <p class="mb-1 small">Get up to <span class="text-danger">10% off</span> at stores.</p>
          </div>
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>No Cost EMI</strong>
            <p class="mb-1 small">Get it for ₹2154/m</p>
          </div>
        </div>
      </div>
    -->
      <!-- ===== Delivery Check ===== -->
      <div class="mt-4">
        <h5>Check Delivery Date</h5>
        <div class="input-group" style="max-width: 350px;">
          <input type="text" id="pincodeInput" class="form-control" placeholder="Enter Pincode">
          <button class="btn btn-outline-secondary" id="pincodeClick" onclick="checkDelivery()">APPLY</button>
        </div>
        <small class="text-muted" id="text-para">Enter your pincode to check delivery availability, assembly info &
          details</small><br>
        <small class="text-muted" id="text-para2"></small>
      </div>

      <!-- ===== Customer Reviews Section ===== -->
      <div class="mt-5">
        <h4>Customer Reviews</h4>
        <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
  <!-- Review text -->
  <div>
    {% if reviews.count == 0 %}
      <span>No reviews yet. Be the first to review!</span>
    {% else %}
    {% if overall_rating == 5 %}<span class="text-warning fs-4">
            ★★★★★
            {% elif overall_rating == 4 %}
            ★★★★
            {% elif overall_rating == 3 %}
            ★★★
            {% elif overall_rating == 2 %}
            ★★
            {% elif overall_rating == 1 %}
            ★
            {% endif %}
          </span>
      <span>Based on {{ reviews.count }} review{{ reviews.count|pluralize }}</span>
    {% endif %}
  </div>

  <!-- Review button -->
  <div class="mt-2 mt-sm-0">
    <button class="btn btn-outline-dark btn-sm review-btn"
            data-bs-toggle="modal" data-bs-target="#reviewModal">
      Write a review
    </button>
  </div>
</div>



        
        {% if reviews.count != 0 %}
        <!-- Ratings Breakdown -->
        <div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★★★★</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{ review_dict.five_star|percentage:reviews.count }}%">
              </div>
            </div>
            <small>{{ review_dict.five_star|percentage:reviews.count }}% ({{ review_dict.five_star }})</small>
          </div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★★★☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{ review_dict.four_star|percentage:reviews.count }}%">
              </div>
            </div>
            <small>{{ review_dict.four_star|percentage:reviews.count }}% ({{ review_dict.four_star }})</small>
          </div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★★☆☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{review_dict.three_star|percentage:reviews.count}}%">
              </div>
            </div>
            <small>{{ review_dict.three_star|percentage:reviews.count }}% ({{review_dict.three_star}})</small>
          </div>
          <div class="d-flex align-items-center mb-1">
            <span class="text-warning">★★☆☆☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{review_dict.two_star|percentage:reviews.count}}%">
              </div>
            </div>
            <small>{{review_dict.two_star|percentage:reviews.count}}% ({{review_dict.two_star }})</small>
          </div>
          <div class="d-flex align-items-center mb-3">
            <span class="text-warning">★☆☆☆☆</span>
            <div class="progress mx-2 flex-grow-1" style="height:10px;">
              <div class="progress-bar bg-warning" style="width: {{ review_dict.one_star|percentage:reviews.count }}%">
              </div>
            </div>
            <small>{{ review_dict.one_star|percentage:reviews.count }}% ({{review_dict.one_star}})</small>
          </div>
        </div>

        <!-- Sort Dropdown -->
        <div class="mb-3">
          <select class="form-select form-select-sm" id="sort_order" style="max-width:200px;" onchange="">
            <option selected value="most_recent">Most Recent</option>
            <option value="highest_rating">Highest Rating</option>
            <option value="lowest-rating">Lowest Rating</option>
          </select>
        </div>
        {% endif %}

        <!-- Reviews Loop -->
        {% for review in reviews %}
        <div class="border-top pt-3 pb-3">
          <div class="d-flex align-items-center mb-1">
            <div class="rounded-circle bg-dark d-flex justify-content-center align-items-center me-2"
              style="width:40px;height:40px;font-weight:bold;">
              {% if review.customer %}
              {{ review.customer.first_name|first|upper }}
              {% else %}
              {{ review.name|first|upper }}
              {% endif %}
            </div>
            <div>
              <div>
                <span class="text-warning">
                  {% if review.rating == 5 %}★★★★★
                  {% elif review.rating == 4 %}★★★★
                  {% elif review.rating == 3 %}★★★
                  {% elif review.rating == 2 %}★★
                  {% elif review.rating == 1 %}★
                  {% endif %}
                </span>
                <small class="text-muted">{{ review.created_at|timesince }} ago</small>
              </div>
              <div>
                {% if review.customer.first_name %}
                <span class="badge bg-dark">Verified</span>
                <strong>{{ review.customer.first_name | capfirst }}</strong>
                {% else %}
                <strong>{{ review.name | capfirst }}</strong>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="fw-bold">{{ review.title }}</div>
          
          <p class="mb-0">{{ review.review }}</p>
          {% if review.img %}
          <div class="jdgm-rev__pics">
            <a class="jdgm-rev__pic-link" target="_blank" rel="nofollow"
              href="{{review.img.url}}"
              data-mfp-src="{{review.img.url}}"
              aria-label="Link to user picture 1">
              <img class="jdgm-rev__pic-img" alt="User picture"
                data-src="{{review.img.url}}"
                src="{{review.img.url}}">
            </a>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

    </div>

  </div>
</div>

<!-- Track Order Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModal">Drop a review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="review-container">
          <form method="POST" enctype="multipart/form-data" id="review-form">
            {% csrf_token %}
            {% if not user.is_authenticated %}
            <label>Name</label>
            <input type="text" class="reviewmodalpop" name="name" id="name" value="{{ form.name.value|default:'' }}">
            {% endif %}
            <div class="product-info">
              <img src="{{product.img.url}}" alt="Product Image" style="width: 80px; height: 80px;">
              <strong>How was the item?</strong>
            </div>

            <div class="stars">
              {% if form.instance.rating == 5 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star selected" data-value="3">&#9733;</span>
              <span class="star selected" data-value="4">&#9733;</span>
              <span class="star selected" data-value="5">&#9733;</span>
              {% elif form.instance.rating == 4 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star selected" data-value="3">&#9733;</span>
              <span class="star selected" data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 3 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star selected" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 2 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star selected" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 1 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% elif form.instance.rating == 0 %}
              <span class="star selected" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% else %}
              <span class="star" data-value="1">&#9733;</span>
              <span class="star" data-value="2">&#9733;</span>
              <span class="star" data-value="3">&#9733;</span>
              <span class="star " data-value="4">&#9733;</span>
              <span class="star " data-value="5">&#9733;</span>
              {% endif %}
            </div>

            <!-- Hidden input to store the rating -->
            <input type="hidden" name="rating" id="rating" value="{{ form.rating.value|default:'' }}" required>

            <textarea class="reviewmodalpop" name="review" rows="4"
              placeholder="What should other customers know?">{{form.review.value|default:''}}</textarea>

            <label class="upload-area">
              <input type="file" name="img" id="img" accept="image/png, image/jpeg">
              <div>Share a photo</div>
            </label>
            <img id="preview" src="{% if form.instance.img %}{{ form.instance.img.url }}{% else %}#{% endif %}"
              alt="Image Preview"
              style="width: 80px; height: 80px; {% if not form.instance.img %}display: none;{% endif %}"><br>

            <input type="text" class="reviewmodalpop" name="title" placeholder="Review Title" required
              value="{{ form.title.value|default:'' }}">

            <button type="submit" class="submit-btn btn btn-outline-secondary w-100">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .border-orange {
    border: 1px solid #ff6600;
    border-radius: 6px;
  }


  .review-container {
    max-width: 500px;
    margin: 0 auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .product-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
  }

  .product-info img {
    width: 80px;
    height: 80px;
    object-fit: cover;
  }

  .stars {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    font-size: 1.5rem;
    cursor: pointer;
    justify-content: center;
  }

  .star {
    color: lightgray;
    transition: color 0.2s;
  }

  .star.hover,
  .star.selected {
    color: gold;
  }

  .reviewmodalpop {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
    font-size: 1rem;
  }

  .upload-area {
    border: 2px dashed #ccc;
    border-radius: 4px;
    text-align: center;
    padding: 20px;
    color: #777;
    margin-bottom: 15px;
    cursor: pointer;
  }

  .upload-area input {
    display: none;
  }

  .review-btn {
  min-width: 150px; /* keeps good size on large screens */
}

@media (max-width: 576px) {
  .review-btn {
    width: 100%;  /* full width under text on small screens */
    min-width: auto;
  }
}
.jdgm-rev__pic-link {
    margin: 8px 5px 3px 0;
    padding: 0;
    display: inline-block;
    height: 120px;
    width: auto;
    cursor: pointer;
    overflow: hidden;
}
.jdgm-rev__pics {
    font-size: 0;
    white-space: nowrap;
    height: auto;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
}
.jdgm-rev__pic-img {
    display: block;
    width: auto;
    max-height: 100%;
    margin: 0;
    padding: 0;
    position: relative;
    top: 50%;
    transform: translateY(-50%);
    -webkit-transform: translateY(-50%);
    border-radius: 4px;
}
</style>

{% endblock content %}