{% extends 'main.html' %}
{% load humanize %}
{% block content %}
{% load static %}
<div class="container py-5">
  <div class="row">
    <!-- Product Images (Sticky Left) -->
    <div class="col-md-6">
      <div class="sticky-top" style="top: 100px;"> <!-- adjust top offset as needed -->
        <img id="mainImage" src="{{product.img.url}}" class="img-fluid mb-3" alt="Main Image">
        <div class="d-flex">
          <img src="{{product.img.url}}" class="thumbnail-img active" width="60" onclick="changeImage(this)">
          <img src="{{product.img2.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
          <img src="{{product.img3.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
          <img src="{{product.img3.url}}" class="thumbnail-img" width="60" onclick="changeImage(this)">
        </div>
      </div>
    </div>

    <!-- Product Details (Scrollable Right) -->
    <div class="col-md-6">
      <h4>{{product.name}}</h4>
      <p class="mb-1">
        <strong>₹{{product.discounted_price | intcomma}}</strong>
        <span class="price-original">₹{{product.original_price | intcomma}}</span>
        <small>(Including GST)</small>
      </p>
      <p class="text-success">
        You Save ₹{{product.savings}} ({{product.savings_percentage}}% OFF)
      </p>
      <p>{{product.warranty}} Year Warranty</p>

      <!-- Price Table -->
      <table class="table table-sm">
        <tbody>
          <tr>
            <td><strong>Total Savings</strong></td>
            <td class="text-danger">₹{{product.savings}}</td>
          </tr>
          <tr>
            <td><strong>Assembly</strong></td>
            <td>{{product.assembly}}</td>
          </tr>
          <tr>
            <td><strong>Customization</strong></td>
            <td>{{product.customization}}</td>
          </tr>
          <tr>
            <td><strong>Tax</strong></td>
            <td>18%</td>
          </tr>
        </tbody>
      </table>

      <!-- Quantity & Price -->
      <div class="d-flex align-items-center mb-3">
        <button class="btn btn-outline-secondary btn-sm" onclick="adjustQty(-1)">-</button>
        <input id="qtyInput" type="text" value="1" class="form-control form-control-sm mx-2 text-center"
          style="width: 50px;">
        <button class="btn btn-outline-secondary btn-sm" onclick="adjustQty(1)">+</button>
        <strong class="ms-3">₹<span id="totalPrice">{{product.discounted_price}}</span></strong>
      </div>

      <!-- Actions -->
      <form>
        <div class="d-flex flex-column flex-sm-row gap-2 mb-4">
          <button class="btn btn-orange w-100" id="buynow" formaction="/buy/{{ product.id }}/1/">Buy Now</button>
          <button class="btn btn-outline-secondary w-100" id="addtocart" formaction="/add/{{ product.id }}/1/">Add to
            Cart</button>
        </div>
      </form>

      <!-- ===== Offers Section ===== 

      <div class="mt-4">
        <h5>Save Extra with Below Offers</h5>
        <div class="d-flex flex-wrap gap-2">
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>InstantCart Deals</strong>
            <p class="mb-1 small">Get Up to <span class="text-danger">5% off</span> Order Now — Limited-Time!</p>
          </div>
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>Store Discount</strong>
            <p class="mb-1 small">Get up to <span class="text-danger">10% off</span> at stores.</p>
          </div>
          <div class="card p-2 flex-fill text-center border-orange" style="min-width:150px;">
            <strong>No Cost EMI</strong>
            <p class="mb-1 small">Get it for ₹2154/m</p>
          </div>
        </div>
      </div>
    -->
      <!-- ===== Delivery Check ===== -->
      <div class="mt-4">
        <h5>Check Delivery Date</h5>
        <div class="input-group" style="max-width: 350px;">
          <input type="text" id="pincodeInput" class="form-control" placeholder="Enter Pincode">
          <button class="btn btn-outline-secondary" id="pincodeClick" onclick="checkDelivery()">APPLY</button>
        </div>
        <small class="text-muted" id="text-para">Enter your pincode to check delivery availability, assembly info &
          details</small><br>
        <small class="text-muted" id="text-para2"></small>
      </div>
    </div>
  </div>
</div>

<style>
  .border-orange {
    border: 1px solid #ff6600;
    border-radius: 6px;
  }
</style>

<!-- JS -->
<script>

  var input = document.getElementById("pincodeInput");
  // Execute a function when the user presses a key on the keyboard
  input.addEventListener("keypress", function (event) {
    // If the user presses the "Enter" key on the keyboard
    if (event.key === "Enter") {
      // Cancel the default action, if needed
      event.preventDefault();
      // Trigger the button element with a click
      document.getElementById("pincodeClick").click();
    }
  });
  function checkDelivery() {
    const pincode = document.getElementById("pincodeInput").value;
    const result = document.getElementById("text-para");
    const result2 = document.getElementById("text-para2");
    const now = new Date();
    const istDate = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    let today = new Date();
    fetch(`https://api.postalpincode.in/pincode/${pincode}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })

      .then(data => {
        if (data[0].Status == "Success") {
          const locarray = ["Thrissur", "Alappuzha", "Ernakulam"]
          const location = data[0]["PostOffice"];
          result.setAttribute('style', 'font-weight:bold')
          for (let index = 0; index < location.length; index++) {
            if (locarray.includes(location[index].District)) {
              if ((today.getDate() + 2) > (getDaysInMonth(today.getFullYear(), today.getMonth()))) {
                let month = today.getMonth();
                const newDate = (today.getDate() + 2) - (getDaysInMonth(today.getFullYear(), today.getMonth() + 1));
                today.setDate(newDate);
                today.setMonth(month + 1);
                result.innerText = `FREE delivery by ${days[today.getDay()]}, ${today.getDate()} ${months[today.getMonth()]} `;
                result2.innerText = `Deliver to ${location[index].Division},${location[index].District} ${pincode} `;
              } else {
                result.innerText = `FREE delivery by ${days[today.getDay() + 2]}, ${today.getDate() + 2} ${months[today.getMonth()]} `;
                result2.innerText = `Deliver to ${location[index].Block},${location[index].District} ${pincode} `;
              }
              break;
            } else {
              if ((today.getDate() + 7) > (getDaysInMonth(today.getFullYear(), today.getMonth()))) {
                let month = today.getMonth();
                const newDate = (today.getDate() + 7) - (getDaysInMonth(today.getFullYear(), today.getMonth() + 1));
                today.setDate(newDate);
                today.setMonth(month + 1);
                result.innerText = `FREE delivery by ${days[today.getDay()]}, ${today.getDate()} ${months[today.getMonth()]} `;
                result2.innerText = `Deliver to ${location[index].Block},${location[index].District} ${pincode} `;
              } else {
                result.innerText = `FREE delivery by ${days[today.getDay() + 7]}, ${istDate.getDate() + 7} ${months[today.getMonth()]} `;
                result2.innerText = `Deliver to ${location[index].Block},${location[index].District} ${pincode} `;
              }
              break;
            }
          }
        } else {
          result.setAttribute('style', 'font-weight:bold');
          result.innerText = "Please enter a valid pincode";
          result2.innerText = "";
        }

      })
      .catch(error => console.error('There was a problem with the fetch operation:', error));

  }

  function getDaysInMonth(year, month) {
    return new Date(year, month, 0).getDate();
  }
  const mainImage = document.getElementById("mainImage");
  const thumbnails = document.querySelectorAll(".thumbnail-img");
  const qtyInput = document.getElementById("qtyInput");
  const url = document.getElementById("addtocart");
  const url2 = document.getElementById("buynow");
  let qtyValue = qtyInput.value;
  const totalPriceEl = document.getElementById("totalPrice");
  const pricePerUnit = parseInt(document.getElementById("totalPrice").textContent.replace(",", ""));
  const productId = "{{ product.id }}";

  function changeImage(el) {
    thumbnails.forEach(img => img.classList.remove("active"));
    el.classList.add("active");
    mainImage.src = el.src;
  }

  function adjustQty(val) {
    let qty = parseInt(qtyInput.value);
    qty = isNaN(qty) ? 1 : qty;
    qty = Math.max(1, qty + val);
    qtyInput.value = qty;
    qtyValue = qty;
    url.setAttribute("formaction", `/add/${productId}/${qtyValue}/`);
    url2.setAttribute("formaction", `/buy/${productId}/${qtyValue}/`)
    totalPriceEl.textContent = qty * pricePerUnit;
  }

  qtyInput.addEventListener("input", () => {
    let qty = parseInt(qtyInput.value);
    qty = isNaN(qty) || qty < 1 ? 1 : qty;
    qtyInput.value = qty;
    totalPriceEl.textContent = qty * pricePerUnit;
  });




</script>
{% endblock content %}